<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
  게시글 Mapper XML

  게시글 목록 조회, 상세 조회, 등록, 수정, 삭제 등의 SQL 쿼리 정의
-->
<mapper namespace="com.board.dao.BoardDAO">

  <!-- ========================================
       Result Map 정의
       ======================================== -->

  <!--
    게시글 기본 Result Map
    Board DTO의 모든 필드를 매핑
  -->
  <resultMap id="BoardResultMap" type="Board">
    <id property="boardId" column="board_id"/>
    <result property="categoryId" column="category_id"/>
    <result property="title" column="title"/>
    <result property="content" column="content"/>
    <result property="userName" column="user_name"/>
    <result property="password" column="password"/>
    <result property="views" column="views"/>
    <result property="createdAt" column="created_at"/>
    <result property="editedAt" column="edited_at"/>
    <result property="categoryName" column="category_name"/>
    <result property="hasFile" column="has_file"/>
  </resultMap>

  <!-- ========================================
       게시글 목록 조회
       ======================================== -->

  <!--
    페이징된 게시글 목록 조회
    - 카테고리 조인으로 카테고리명 조회
    - 첨부파일 존재 여부 확인 (서브쿼리)
    - 최신순 정렬 (created_at DESC)
    - LIMIT, OFFSET으로 페이징 처리

    @param offset 시작 위치 (0부터 시작)
    @param pageSize 페이지당 게시글 수
    @return 게시글 목록
  -->
  <select id="selectBoardList" resultMap="BoardResultMap">
    SELECT
      b.board_id,
      b.category_id,
      b.title,
      b.content,
      b.user_name,
      b.views,
      b.created_at,
      b.edited_at,
      c.category_name,
      CASE
        WHEN EXISTS (
          SELECT 1
          FROM file f
          WHERE f.board_id = b.board_id
        ) THEN TRUE
        ELSE FALSE
      END AS has_file
    FROM board b
    INNER JOIN category c ON b.category_id = c.category_id
    ORDER BY b.created_at DESC
    LIMIT #{pageSize} OFFSET #{offset}
  </select>

  <!-- ========================================
       전체 게시글 수 조회
       ======================================== -->

  <!--
    전체 게시글 수 조회
    페이지네이션 계산에 사용

    @return 전체 게시글 수
  -->
  <select id="countBoards" resultType="int">
    SELECT COUNT(*)
    FROM board
  </select>

  <!-- ========================================
       게시글 상세 조회
       ======================================== -->

  <!--
    게시글 ID로 게시글 상세 정보 조회
    카테고리 조인으로 카테고리명 포함

    @param boardId 게시글 ID
    @return 게시글 상세 정보
  -->
  <select id="selectBoardById" resultMap="BoardResultMap">
    SELECT
      b.board_id,
      b.category_id,
      b.title,
      b.content,
      b.user_name,
      b.password,
      b.views,
      b.created_at,
      b.edited_at,
      c.category_name
    FROM board b
    INNER JOIN category c ON b.category_id = c.category_id
    WHERE b.board_id = #{boardId}
  </select>

  <!-- ========================================
       조회수 증가
       ======================================== -->

  <!--
    게시글 조회수 1 증가
    페이지 진입 시마다 실행

    @param boardId 게시글 ID
  -->
  <update id="updateViewCount">
    UPDATE board
    SET views = views + 1
    WHERE board_id = #{boardId}
  </update>

  <!-- ========================================
       게시글 등록
       ======================================== -->

  <!--
    게시글 등록
    비밀번호는 SHA2(256)로 해싱하여 저장
    생성된 boardId를 반환 (useGeneratedKeys)

    @param board 게시글 정보
  -->
  <insert id="insertBoard" parameterType="Board" useGeneratedKeys="true" keyProperty="boardId">
    INSERT INTO board (
      category_id,
      title,
      content,
      user_name,
      password,
      views,
      created_at
    ) VALUES (
      #{categoryId},
      #{title},
      #{content},
      #{userName},
      SHA2(#{password}, 256),
      0,
      CURRENT_TIMESTAMP
    )
  </insert>

  <!-- ========================================
       비밀번호 확인
       ======================================== -->

  <!--
    게시글 비밀번호 확인
    수정/삭제 전 작성자 확인에 사용
    SHA2(256)로 해싱하여 비교

    @param boardId 게시글 ID
    @param password 입력한 비밀번호
    @return 일치하면 1, 불일치하면 0
  -->
  <select id="checkPassword" resultType="int">
    SELECT COUNT(*)
    FROM board
    WHERE board_id = #{boardId}
      AND password = SHA2(#{password}, 256)
  </select>

  <!-- ========================================
       게시글 수정
       ======================================== -->

  <!--
    게시글 수정
    제목, 내용만 수정 가능
    edited_at 자동 갱신

    @param board 수정할 게시글 정보 (boardId, title, content)
  -->
  <update id="updateBoard" parameterType="Board">
    UPDATE board
    SET title = #{title},
        content = #{content},
        edited_at = CURRENT_TIMESTAMP
    WHERE board_id = #{boardId}
  </update>

</mapper>
