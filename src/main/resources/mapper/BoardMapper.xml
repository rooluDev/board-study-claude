<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
  Board 테이블 MyBatis Mapper

  네임스페이스: com.board.dao.BoardDAO
  설명: 게시글 관련 SQL 쿼리 정의
-->
<mapper namespace="com.board.dao.BoardDAO">

  <!-- Board 결과 매핑 -->
  <resultMap id="BoardResultMap" type="Board">
    <id property="boardId" column="board_id"/>
    <result property="categoryId" column="category_id"/>
    <result property="title" column="title"/>
    <result property="content" column="content"/>
    <result property="userName" column="user_name"/>
    <result property="password" column="password"/>
    <result property="views" column="views"/>
    <result property="createdAt" column="created_at"/>
    <result property="editedAt" column="edited_at"/>
    <result property="categoryName" column="category_name"/>
    <result property="fileCount" column="file_count"/>
  </resultMap>

  <!--
    게시글 목록 조회 (페이징, 검색)

    파라미터:
    - limit: 페이지당 게시글 수 (PAGE_SIZE)
    - offset: 시작 위치 ((page - 1) * PAGE_SIZE)
    - category: 카테고리 ID (선택)
    - keyword: 검색어 (선택, 제목/내용/작성자)
    - from: 등록일시 시작 (선택)
    - to: 등록일시 종료 (선택)

    반환: List<Board>
  -->
  <select id="selectBoardList" resultMap="BoardResultMap">
    SELECT
      b.board_id,
      b.category_id,
      b.title,
      b.user_name,
      b.views,
      b.created_at,
      b.edited_at,
      c.category_name,
      (SELECT COUNT(*) FROM file f WHERE f.board_id = b.board_id) AS file_count
    FROM board b
    LEFT JOIN category c ON b.category_id = c.category_id
    <where>
      <if test="category != null">
        AND b.category_id = #{category}
      </if>
      <if test="keyword != null and keyword != ''">
        AND (
          b.title LIKE CONCAT('%', #{keyword}, '%')
          OR b.content LIKE CONCAT('%', #{keyword}, '%')
          OR b.user_name LIKE CONCAT('%', #{keyword}, '%')
        )
      </if>
      <if test="from != null and from != ''">
        AND b.created_at &gt;= #{from}
      </if>
      <if test="to != null and to != ''">
        AND b.created_at &lt; DATE_ADD(#{to}, INTERVAL 1 DAY)
      </if>
    </where>
    ORDER BY b.created_at DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <!--
    전체 게시글 수 조회 (검색)

    파라미터:
    - category: 카테고리 ID (선택)
    - keyword: 검색어 (선택, 제목/내용/작성자)
    - from: 등록일시 시작 (선택)
    - to: 등록일시 종료 (선택)

    반환: int
  -->
  <select id="countBoards" resultType="int">
    SELECT COUNT(*)
    FROM board b
    <where>
      <if test="category != null">
        AND b.category_id = #{category}
      </if>
      <if test="keyword != null and keyword != ''">
        AND (
          b.title LIKE CONCAT('%', #{keyword}, '%')
          OR b.content LIKE CONCAT('%', #{keyword}, '%')
          OR b.user_name LIKE CONCAT('%', #{keyword}, '%')
        )
      </if>
      <if test="from != null and from != ''">
        AND b.created_at &gt;= #{from}
      </if>
      <if test="to != null and to != ''">
        AND b.created_at &lt; DATE_ADD(#{to}, INTERVAL 1 DAY)
      </if>
    </where>
  </select>

  <!--
    게시글 상세 조회 (ID로 조회)

    파라미터:
    - boardId: 게시글 ID

    반환: Board
  -->
  <select id="selectBoardById" resultMap="BoardResultMap">
    SELECT
      b.board_id,
      b.category_id,
      b.title,
      b.content,
      b.user_name,
      b.password,
      b.views,
      b.created_at,
      b.edited_at,
      c.category_name
    FROM board b
    LEFT JOIN category c ON b.category_id = c.category_id
    WHERE b.board_id = #{boardId}
  </select>

  <!--
    조회수 증가

    파라미터:
    - boardId: 게시글 ID
  -->
  <update id="updateViewCount">
    UPDATE board
    SET views = views + 1
    WHERE board_id = #{boardId}
  </update>

  <!--
    게시글 등록

    파라미터:
    - categoryId: 카테고리 ID
    - title: 제목
    - content: 내용
    - userName: 작성자
    - password: 비밀번호 (평문, SHA2로 해싱하여 저장)

    반환: 생성된 게시글 ID (useGeneratedKeys)
  -->
  <insert id="insertBoard" useGeneratedKeys="true" keyProperty="boardId">
    INSERT INTO board (
      category_id,
      title,
      content,
      user_name,
      password,
      views
    ) VALUES (
      #{categoryId},
      #{title},
      #{content},
      #{userName},
      SHA2(#{password}, 256),
      0
    )
  </insert>

  <!--
    게시글 수정

    파라미터:
    - boardId: 게시글 ID
    - title: 제목
    - content: 내용
  -->
  <update id="updateBoard">
    UPDATE board
    SET
      title = #{title},
      content = #{content},
      edited_at = CURRENT_TIMESTAMP
    WHERE board_id = #{boardId}
  </update>

  <!--
    게시글 삭제

    파라미터:
    - boardId: 게시글 ID
  -->
  <delete id="deleteBoard">
    DELETE FROM board
    WHERE board_id = #{boardId}
  </delete>

  <!--
    비밀번호 확인

    파라미터:
    - boardId: 게시글 ID
    - password: 비밀번호 (평문)

    반환: 일치하면 1, 불일치하면 0
  -->
  <select id="verifyPassword" resultType="int">
    SELECT COUNT(*)
    FROM board
    WHERE board_id = #{boardId}
      AND password = SHA2(#{password}, 256)
  </select>

</mapper>
