<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
  File 테이블 MyBatis Mapper

  네임스페이스: com.board.dao.FileDAO
  설명: 첨부파일 관련 SQL 쿼리 정의
-->
<mapper namespace="com.board.dao.FileDAO">

  <!-- BoardFile 결과 매핑 -->
  <resultMap id="BoardFileResultMap" type="BoardFile">
    <id property="fileId" column="file_id"/>
    <result property="boardId" column="board_id"/>
    <result property="originalName" column="original_name"/>
    <result property="physicalName" column="physical_name"/>
    <result property="filePath" column="file_path"/>
    <result property="extension" column="extension"/>
    <result property="size" column="size"/>
    <result property="createdAt" column="created_at"/>
    <result property="editedAt" column="edited_at"/>
  </resultMap>

  <!--
    게시글 ID로 첨부파일 목록 조회

    파라미터:
    - boardId: 게시글 ID

    반환: List<BoardFile>
  -->
  <select id="selectFilesByBoardId" resultMap="BoardFileResultMap">
    SELECT
      file_id,
      board_id,
      original_name,
      physical_name,
      file_path,
      extension,
      size,
      created_at,
      edited_at
    FROM file
    WHERE board_id = #{boardId}
    ORDER BY created_at ASC
  </select>

  <!--
    파일 ID로 첨부파일 조회

    파라미터:
    - fileId: 파일 ID

    반환: BoardFile
  -->
  <select id="selectFileById" resultMap="BoardFileResultMap">
    SELECT
      file_id,
      board_id,
      original_name,
      physical_name,
      file_path,
      extension,
      size,
      created_at,
      edited_at
    FROM file
    WHERE file_id = #{fileId}
  </select>

  <!--
    첨부파일 등록

    파라미터:
    - boardId: 게시글 ID
    - originalName: 원본 파일명
    - physicalName: 서버 저장 파일명 (UUID)
    - filePath: 파일 저장 경로
    - extension: 확장자
    - size: 파일 크기 (bytes)

    반환: 생성된 파일 ID (useGeneratedKeys)
  -->
  <insert id="insertFile" useGeneratedKeys="true" keyProperty="fileId">
    INSERT INTO file (
      board_id,
      original_name,
      physical_name,
      file_path,
      extension,
      size
    ) VALUES (
      #{boardId},
      #{originalName},
      #{physicalName},
      #{filePath},
      #{extension},
      #{size}
    )
  </insert>

  <!--
    첨부파일 삭제

    파라미터:
    - fileId: 파일 ID
  -->
  <delete id="deleteFile">
    DELETE FROM file
    WHERE file_id = #{fileId}
  </delete>

  <!--
    게시글의 모든 첨부파일 삭제

    파라미터:
    - boardId: 게시글 ID
  -->
  <delete id="deleteFilesByBoardId">
    DELETE FROM file
    WHERE board_id = #{boardId}
  </delete>

  <!--
    게시글의 첨부파일 개수 조회

    파라미터:
    - boardId: 게시글 ID

    반환: int
  -->
  <select id="countFilesByBoardId" resultType="int">
    SELECT COUNT(*)
    FROM file
    WHERE board_id = #{boardId}
  </select>

  <!--
    여러 파일 ID로 첨부파일 삭제

    파라미터:
    - fileIds: 파일 ID 리스트
  -->
  <delete id="deleteFilesByIds">
    DELETE FROM file
    WHERE file_id IN
    <foreach collection="list" item="fileId" open="(" separator="," close=")">
      #{fileId}
    </foreach>
  </delete>

</mapper>
