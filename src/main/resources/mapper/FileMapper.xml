<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
  첨부파일 Mapper XML

  첨부파일 조회, 등록, 삭제 등의 SQL 쿼리 정의
-->
<mapper namespace="com.board.dao.FileDAO">

  <!-- ========================================
       Result Map 정의
       ======================================== -->

  <!--
    첨부파일 기본 Result Map
    File DTO의 모든 필드를 매핑
  -->
  <resultMap id="FileResultMap" type="File">
    <id property="fileId" column="file_id"/>
    <result property="boardId" column="board_id"/>
    <result property="originalName" column="original_name"/>
    <result property="physicalName" column="physical_name"/>
    <result property="filePath" column="file_path"/>
    <result property="extension" column="extension"/>
    <result property="size" column="size"/>
    <result property="createdAt" column="created_at"/>
    <result property="editedAt" column="edited_at"/>
  </resultMap>

  <!-- ========================================
       게시글별 첨부파일 목록 조회
       ======================================== -->

  <!--
    특정 게시글의 첨부파일 목록 조회
    등록일시 오름차순 정렬

    @param boardId 게시글 ID
    @return 첨부파일 목록
  -->
  <select id="selectFilesByBoardId" resultMap="FileResultMap">
    SELECT
      file_id,
      board_id,
      original_name,
      physical_name,
      file_path,
      extension,
      size,
      created_at,
      edited_at
    FROM file
    WHERE board_id = #{boardId}
    ORDER BY created_at ASC
  </select>

  <!-- ========================================
       첨부파일 등록
       ======================================== -->

  <!--
    단일 첨부파일 등록
    생성된 fileId를 반환 (useGeneratedKeys)

    @param file 파일 정보
  -->
  <insert id="insertFile" parameterType="File" useGeneratedKeys="true" keyProperty="fileId">
    INSERT INTO file (
      board_id,
      original_name,
      physical_name,
      file_path,
      extension,
      size,
      created_at
    ) VALUES (
      #{boardId},
      #{originalName},
      #{physicalName},
      #{filePath},
      #{extension},
      #{size},
      CURRENT_TIMESTAMP
    )
  </insert>

  <!--
    다중 첨부파일 배치 등록
    여러 파일을 한 번에 삽입 (성능 최적화)

    @param files 파일 목록
  -->
  <insert id="insertFiles" parameterType="java.util.List">
    INSERT INTO file (
      board_id,
      original_name,
      physical_name,
      file_path,
      extension,
      size,
      created_at
    ) VALUES
    <foreach collection="list" item="file" separator=",">
      (
        #{file.boardId},
        #{file.originalName},
        #{file.physicalName},
        #{file.filePath},
        #{file.extension},
        #{file.size},
        CURRENT_TIMESTAMP
      )
    </foreach>
  </insert>

  <!-- ========================================
       파일 ID로 조회
       ======================================== -->

  <!--
    파일 ID로 파일 정보 조회
    삭제 전 물리 파일명 확인에 사용

    @param fileId 파일 ID
    @return 파일 정보
  -->
  <select id="selectFileById" resultMap="FileResultMap">
    SELECT
      file_id,
      board_id,
      original_name,
      physical_name,
      file_path,
      extension,
      size,
      created_at,
      edited_at
    FROM file
    WHERE file_id = #{fileId}
  </select>

  <!-- ========================================
       파일 삭제
       ======================================== -->

  <!--
    단일 파일 삭제
    물리 파일 삭제 후 호출

    @param fileId 파일 ID
  -->
  <delete id="deleteFile">
    DELETE FROM file
    WHERE file_id = #{fileId}
  </delete>

  <!--
    여러 파일 삭제
    물리 파일 삭제 후 호출

    @param fileIds 파일 ID 목록
  -->
  <delete id="deleteFilesByIds" parameterType="java.util.List">
    DELETE FROM file
    WHERE file_id IN
    <foreach collection="list" item="fileId" open="(" separator="," close=")">
      #{fileId}
    </foreach>
  </delete>

</mapper>
