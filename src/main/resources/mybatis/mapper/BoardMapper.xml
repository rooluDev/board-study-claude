<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.board.dao.BoardDAO">

  <!-- Result Map -->
  <resultMap id="boardResultMap" type="BoardDTO">
    <id property="boardId" column="board_id"/>
    <result property="categoryId" column="category_id"/>
    <result property="title" column="title"/>
    <result property="content" column="content"/>
    <result property="userName" column="user_name"/>
    <result property="password" column="password"/>
    <result property="views" column="views"/>
    <result property="createdAt" column="created_at"/>
    <result property="editedAt" column="edited_at"/>
    <result property="categoryName" column="category_name"/>
    <result property="hasAttachment" column="has_attachment"/>
  </resultMap>

  <!-- ID로 게시글 조회 -->
  <select id="selectById" parameterType="long" resultMap="boardResultMap">
    SELECT
      b.board_id,
      b.category_id,
      b.title,
      b.content,
      b.user_name,
      b.password,
      b.views,
      b.created_at,
      b.edited_at,
      c.category_name,
      (SELECT COUNT(*) FROM file WHERE board_id = b.board_id) > 0 AS has_attachment
    FROM board b
    INNER JOIN category c ON b.category_id = c.category_id
    WHERE b.board_id = #{boardId}
  </select>

  <!-- 검색 조건에 따른 게시글 목록 조회 -->
  <select id="selectList" parameterType="SearchCondition" resultMap="boardResultMap">
    SELECT
      b.board_id,
      b.category_id,
      b.title,
      b.content,
      b.user_name,
      b.views,
      b.created_at,
      b.edited_at,
      c.category_name,
      (SELECT COUNT(*) FROM file WHERE board_id = b.board_id) > 0 AS has_attachment
    FROM board b
    INNER JOIN category c ON b.category_id = c.category_id
    WHERE 1=1
    <if test="categoryId != null">
      AND b.category_id = #{categoryId}
    </if>
    <if test="from != null">
      AND DATE(b.created_at) &gt;= #{from}
    </if>
    <if test="to != null">
      AND DATE(b.created_at) &lt;= #{to}
    </if>
    <if test="keyword != null and keyword != ''">
      AND (b.title LIKE CONCAT('%', #{keyword}, '%')
           OR b.content LIKE CONCAT('%', #{keyword}, '%')
           OR b.user_name LIKE CONCAT('%', #{keyword}, '%'))
    </if>
    ORDER BY b.created_at DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <!-- 검색 조건에 따른 게시글 총 개수 -->
  <select id="count" parameterType="SearchCondition" resultType="int">
    SELECT COUNT(*)
    FROM board b
    WHERE 1=1
    <if test="categoryId != null">
      AND b.category_id = #{categoryId}
    </if>
    <if test="from != null">
      AND DATE(b.created_at) &gt;= #{from}
    </if>
    <if test="to != null">
      AND DATE(b.created_at) &lt;= #{to}
    </if>
    <if test="keyword != null and keyword != ''">
      AND (b.title LIKE CONCAT('%', #{keyword}, '%')
           OR b.content LIKE CONCAT('%', #{keyword}, '%')
           OR b.user_name LIKE CONCAT('%', #{keyword}, '%'))
    </if>
  </select>

  <!-- 게시글 등록 -->
  <insert id="insert" parameterType="BoardDTO" useGeneratedKeys="true" keyProperty="boardId">
    INSERT INTO board (
      category_id,
      title,
      content,
      user_name,
      password,
      views
    ) VALUES (
      #{categoryId},
      #{title},
      #{content},
      #{userName},
      SHA2(#{password}, 256),
      0
    )
  </insert>

  <!-- 게시글 수정 -->
  <update id="update" parameterType="BoardDTO">
    UPDATE board
    SET title = #{title},
        content = #{content},
        edited_at = CURRENT_TIMESTAMP
    WHERE board_id = #{boardId}
  </update>

  <!-- 조회수 증가 -->
  <update id="incrementViews" parameterType="long">
    UPDATE board
    SET views = views + 1
    WHERE board_id = #{boardId}
  </update>

  <!-- 게시글 삭제 -->
  <delete id="delete" parameterType="long">
    DELETE FROM board
    WHERE board_id = #{boardId}
  </delete>

  <!-- 비밀번호 확인 -->
  <select id="verifyPassword" parameterType="map" resultType="int">
    SELECT COUNT(*)
    FROM board
    WHERE board_id = #{boardId}
      AND password = SHA2(#{password}, 256)
  </select>

</mapper>
